<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAMISAS 10</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column; /* Manter como coluna para empilhar seções */
        }

        .header {
            background: url('https://images.unsplash.com/photo-1517649762945-04ce191ade63?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D') no-repeat center center;
            background-size: cover;
            color: white;
            text-align: center;
            padding: 30px;
            position: relative;
            overflow: hidden;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
        }

        /* Overlay para legibilidade do texto */
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(71, 165, 75, 1);
            z-index: 1;
        }

        /* Os ícones agora são elementos próprios, não pseudo-elementos do header */
        .header .icon-element {
            position: absolute;
            font-size: 80px; /* Tamanho dos ícones */
            opacity: 0.15; /* Um pouco mais visível */
            z-index: 2; /* Acima do overlay */
        }

        .header .icon-cup { /* Ícone da taça */
            /*top: 10px;*/
            /*left: 10px;*/
            /*content: '🏆';*/ /* Ícone para a taça */
            /*font-size: 60px;*/ /* Taça um pouco menor */
			content: '🏆';
            position: absolute;
            font-size: 120px;
            opacity: 0.1;
            left: -10px;
            bottom: -10px;
            transform: rotate(-30deg);
        }

        .header .icon-ball { /* Ícone da bola */
            bottom: 0px; /* Posicionamento inicial ajustado */
            right: 0px;
            content: '⚽'; /* Ícone para a bola */
            font-size: 100px; /* Bola maior */
            animation: circularSpin 6s infinite linear; /* Nome da animação alterado e velocidade */
            transform-origin: center center;
        }

        /* Keyframes para a animação da bola (NOVA ANIMAÇÃO) */
        @keyframes circularSpin {
            0% {
                transform: translate(0, 0) rotate(0deg); /* Começa no canto inferior direito */
                opacity: 0.15;
            }
            25% {
                transform: translate(-100px, -50px) rotate(90deg); /* Move para cima e esquerda */
                opacity: 0.25;
            }
            50% {
                transform: translate(-200px, 0) rotate(180deg); /* Move para a esquerda */
                opacity: 0.35;
            }
            75% {
                transform: translate(-100px, 50px) rotate(270deg); /* Move para baixo e direita */
                opacity: 0.25;
            }
            100% {
                transform: translate(0, 0) rotate(360deg); /* Volta à posição inicial */
                opacity: 0.15;
            }
        }

        /* Ajuste para que o h1 e p fiquem acima de tudo */
        .header h1, .header p {
            position: relative;
            z-index: 3;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
        }

        .card {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            padding: 25px;
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input[type="text"],
        .form-group input[type="password"],
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input[type="text"]:focus,
        .form-group input[type="password"]:focus,
        .form-group select:focus {
            border-color: #667eea;
            outline: none;
        }

        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease, transform 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background-color: #6c757d;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-danger {
            background-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #333;
        }
        .btn-warning:hover {
            background-color: #e0a800;
        }

        .btn-primary {
            background-color: #007bff;
        }
        .btn-primary:hover {
            background-color: #0069d9;
        }

        .connection-status {
            padding: 10px;
            margin-top: 15px;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
            /* Removido display: none; para sempre mostrar o status */
            display: block; /* Mudar para block para que seja sempre visível */
        }

        .status-loading {
            background-color: #e0f7fa;
            color: #00796b;
        }

        .status-connected {
            background-color: #e6ffe6;
            color: #2e7d32;
        }

        .status-error {
            background-color: #ffebee;
            color: #c62828;
        }

        #playersList {
            margin-top: 20px;
        }

        #playersList > div {
            padding: 15px;
            background-color: #f8f8f8;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        #playersList ul {
            list-style: none;
            padding: 0;
        }

        #playersList li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #playersList li:last-child {
            border-bottom: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            text-align: left;
            padding: 12px 15px;
            border-bottom: 1px solid #f2f2f2;
        }

        th {
            background-color: #f4f4f4;
            color: #555;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9em;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        tr:hover {
            background-color: #f1f1f1;
        }
        
        #teamsContainer {
            display: none;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        #teamsContainer h3 {
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        #teamsContainer ul {
            list-style: none;
            padding: 0;
            background-color: #f0f8ff;
            border: 1px solid #b0e0e6;
            border-radius: 8px;
            padding: 15px;
            min-height: 150px;
        }

        #teamsContainer li {
            padding: 8px 0;
            border-bottom: 1px dashed #c0e0e6;
            font-size: 1.1em;
            color: #444;
        }

        #teamsContainer li:last-child {
            border-bottom: none;
        }

        #resultSection {
            display: none;
            margin-top: 20px;
        }

        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
            text-align: center;
        }

        .stat-item {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .stat-item h4 {
            color: #388e3c;
            margin-bottom: 5px;
        }

        .stat-item p {
            font-size: 1.8em;
            font-weight: bold;
            color: #4CAF50;
        }

        .reset-button-container {
            margin-top: 30px;
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .teams-fixed-container {
            display: none;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .team-fixed-card {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .team-fixed-card ul {
            list-style: none;
            padding: 0;
            margin-top: 10px;
        }

        .team-fixed-card li {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .team-fixed-card li:last-child {
            border-bottom: none;
        }
        
        .modern-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background-color: #ffffff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }

        .modern-table thead th {
            background-color: #f8f8f8;
            color: #555;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9em;
            padding: 15px 20px;
            text-align: left;
            border-bottom: 2px solid #eeeeee;
        }

        .modern-table tbody tr {
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .modern-table tbody tr:nth-child(even) {
            background-color: #fdfdfd;
        }

        .modern-table tbody tr:hover {
            background-color: #f0f8ff;
            transform: scale(1.005);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .modern-table tbody td {
            padding: 12px 20px;
            border-bottom: 1px solid #f5f5f5;
            color: #444;
            font-size: 1em;
        }

        .modern-table tbody td strong {
            color: #4CAF50;
            font-size: 1.15em;
        }

        .pos-badge-minimal {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 0.85em;
            font-weight: bold;
            color: white;
            margin-right: 8px;
            flex-shrink: 0;
        }

        .pos-badge-minimal.pos-1 { background-color: #FFD700; }
        .pos-badge-minimal.pos-2 { background-color: #C0C0C0; }
        .pos-badge-minimal.pos-3 { background-color: #CD7F32; }
        .pos-badge-minimal.pos-default { background-color: #bbbbbb; }

        .modern-table tbody tr.top-rank-row {
            border-left: 5px solid;
        }
        .modern-table tbody tr.top-rank-row.pos-1 { border-color: #FFD700; }
        .modern-table tbody tr.top-rank-row.pos-2 { border-color: #C0C0C0; }
        .modern-table tbody tr.top-rank-row.pos-3 { border-color: #CD7F32; }

        .modern-table tbody tr.top-rank-row td:first-child {
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }
        
        #reservesSection h2 {
            color: #2E7D32;
            border-bottom: 2px solid #81C784;
        }

        #reservesList li {
            padding: 8px 0;
            border-bottom: 1px dashed #A5D6A7;
            font-size: 1.1em;
            color: #4CAF50;
        }

        #reservesList li:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Liga Individual - CAMISAS 10</h1>
            <p>Que vença o melhor!</p>
            <span class="icon-element icon-cup">🏆</span>
            <span class="icon-element icon-ball">⚽</span>
        </header>

        <main class="main-content">
            <section class="card" id="playerManagementSection">
                <h2>➕ Adicionar Jogador</h2>
                <div class="form-group">
                    <label for="newPlayerName">Nome do Jogador:</label>
                    <input type="text" id="newPlayerName" placeholder="Nome do jogador">
                </div>
                <button class="btn" onclick="window.addPlayer()">Adicionar Jogador</button>
                
                <h2 style="margin-top: 30px;">👥 Jogadores Cadastrados</h2>
                <div id="playersList">
                    <p>Nenhum jogador cadastrado.</p>
                </div>
            </section>

            <section class="card" id="drawSection">
                <h2>🎯 Sorteio de Times</h2>
                <div class="teams-fixed-container">
                    <div class="team-fixed-card">
                        <h3>Jogadores Fixos - Time A</h3>
                        <ul id="fixedTeamA_list">
                            </ul>
                    </div>
                    <div class="team-fixed-card">
                        <h3>Jogadores Fixos - Time B</h3>
                        <ul id="fixedTeamB_list">
                            </ul>
                    </div>
                </div>

                <button class="btn" id="drawButton" onclick="window.drawTeams()" disabled>
                    🚫 Adicione jogadores para sortear (0/12)
                </button>

                <div id="teamsContainer">
                    <div class="team-card">
                        <h3>Time A</h3>
                        <ul id="teamA"></ul>
                    </div>
                    <div class="team-card">
                        <h3>Time B</h3>
                        <ul id="teamB"></ul>
                    </div>
                </div>

                <div id="resultSection">
                    <h3 class="section-title">📊 Registrar Resultado</h3>
                    <div class="form-group">
                        <label for="gameResult">Vencedor:</label>
                        <select id="gameResult">
                            <option value="">Selecione o resultado</option>
                            <option value="teamA">Time A</option>
                            <option value="teamB">Time B</option>
                            <option value="draw">Empate</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="window.registerResult()">Registrar Resultado</button>
                </div>
            </section>

            <section class="card" id="reservesSection" style="display: none;">
                <h2>👥 Jogadores no Banco / Não Selecionados</h2>
                <ul id="reservesList">
                    </ul>
            </section>

            <section class="card" id="rankingSection">
                <h2>🏆 Classificação Geral</h2>
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>Pos.</th>
                            <th>Nome</th>
                            <th>Pts</th>
                            <th>V</th>
                            <th>E</th>
                            <th>D</th>
                        </tr>
</thead>
                    <tbody id="rankingTableBody">
                        <tr><td colspan="6" style="text-align: center; color: #777;">Carregando classificação...</td></tr>
                    </tbody>
                </table>
            </section>

            <section class="card" id="statsSection">
                <h2>📈 Estatísticas</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <h4>Total de Jogadores</h4>
                        <p id="totalPlayers">0</p>
                    </div>
                    <div class="stat-item">
                        <h4>Líder em Pontos</h4>
                        <p id="leaderPoints">0</p>
                    </div>
                </div>
            </section>
            
            <div id="connectionStatus" class="connection-status"></div>
            <section class="card reset-button-container" id="dataManagementSection" style="display:none">
                <h2>⚠️ Gerenciamento de Dados</h2>
                <button class="btn btn-danger" onclick="window.resetAllData()">Resetar Todos os Dados</button>
            </section>
        </main>
    </div>

    <script>
        // *** SUAS CREDENCIAIS SUPABASE AQUI ***
        // Por favor, substitua 'YOUR_SUPABASE_URL_HERE' e 'YOUR_SUPABASE_ANON_KEY_HERE'
        // pelas suas credenciais reais do projeto Supabase.
        // CUIDADO: Ao fazer deploy público, essas chaves ficarão visíveis no código fonte do navegador.
        // Para aplicações em produção, considere usar variáveis de ambiente ou um backend para esconder as chaves.
        const SUPABASE_URL = 'https://ofdaxmhklseogkfsvmdx.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9mZGF4bWhrbHNlb2drZnN2bWR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4NDMxODIsImV4cCI6MjA2NTQxOTE4Mn0.r1tK0_1QTC5ALqDkMhrvYWmRalltdH12M9sRmdUOgfw'; 
        // ************************************

        let supabase = null;
        let players = [];
        let currentTeamA = [];
        let currentTeamB = [];
        let fixedTeamA = []; 
        let fixedTeamB = []; 
        let isConnected = false;
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOMContentLoaded: Página carregada.");
            
            // Não há mais necessidade de carregar do localStorage ou de input fields
            // A conexão será tentada automaticamente com as constantes
            console.log("Credenciais configuradas. Tentando conectar ao Supabase automaticamente...");
            window.connectSupabase(); 
            
            // --- ESTE BLOCO CARREGA OS TIMES SORTEADOS DO localStorage AO CARREGAR A PÁGINA ---
            const savedTeamA = localStorage.getItem('savedCurrentTeamA');
            const savedTeamB = localStorage.getItem('savedCurrentTeamB');
            const savedReserves = localStorage.getItem('savedPlayersNotInGame');
            const hasDrawn = localStorage.getItem('hasDrawnTeams');

            if (savedTeamA && savedTeamB && hasDrawn === 'true') {
                console.log("Times sorteados encontrados no localStorage. Restaurando...");
                currentTeamA = JSON.parse(savedTeamA);
                currentTeamB = JSON.parse(savedTeamB);
                const playersNotInGame = savedReserves ? JSON.parse(savedReserves) : [];

                window.displayTeams(playersNotInGame);
                document.getElementById('resultSection').style.display = 'block';
                document.getElementById('drawButton').disabled = true;
                document.getElementById('drawButton').innerHTML = '🎯 Times Sorteados';
            } else {
                console.log("Nenhum time sorteado persistido encontrado.");
            }
            // --- FIM DO BLOCO DE CARREGAMENTO DO localStorage ---
        });

        // Conecta ao Supabase
        window.connectSupabase = async function() {
            // Usa as constantes diretamente
            const url = SUPABASE_URL;
            const key = SUPABASE_KEY;
            
            console.log("connectSupabase: Tentando conectar com URL:", url, "e Chave (parcial):", key ? key.substring(0, 5) + '...' : 'N/A'); 

            if (!url || !key || url === 'YOUR_SUPABASE_URL_HERE' || key === 'YOUR_SUPABASE_ANON_KEY_HERE') {
                window.showStatus('❌ Por favor, configure suas credenciais Supabase no código (SUPABASE_URL e SUPABASE_KEY).', 'error');
                console.error("connectSupabase: URL ou chave Supabase inválidas (valores padrão).");
                return;
            }
            
            window.showStatus('🔄 Conectando ao Supabase...', 'loading');
            
            // Adicionado um pequeno atraso para a mensagem de status aparecer antes de prosseguir
            await new Promise(resolve => setTimeout(resolve, 100)); 

            try {
                // Verificar se window.supabase está disponível
                if (typeof window.supabase === 'undefined' || window.supabase === null) {
                    throw new Error("Supabase JS SDK não carregado. Verifique o CDN link.");
                }
                
                supabase = window.supabase.createClient(url, key); 
                console.log("Supabase client criado.");
                
                // Testar a conexão buscando algo simples
                const { data, error } = await supabase.from('jogadores').select('count').limit(1);
                
                if (error) {
                    console.error("Erro ao testar conexão Supabase:", error.message);
                    throw error;
                }
                
                // Não há mais necessidade de salvar no localStorage, pois as credenciais são fixas
                
                isConnected = true;
                window.showStatus('✅ Conectado com sucesso ao Supabase!', 'connected');
                console.log("Conexão Supabase bem-sucedida.");
                
                await window.loadData(); 
                
            } catch (error) {
                console.error('Erro em connectSupabase:', error);
                window.showStatus(`❌ Erro ao conectar: ${error.message}`, 'error');
                isConnected = false;
            }
        };

        // Exibe status da conexão
        window.showStatus = function(message, type) { 
            const statusDiv = document.getElementById('connectionStatus');
            // Removido statusDiv.style.display = 'block'; pois o div já é sempre visível
            statusDiv.textContent = message;
            statusDiv.className = `connection-status status-${type}`;
            console.log(`STATUS: [${type.toUpperCase()}] ${message}`);
        };

        // Carrega dados do Supabase
        window.loadData = async function () {
            if (!isConnected || !supabase) { // Adicionado !supabase check
                console.warn("loadData() chamado, mas não conectado ou supabase client não inicializado.");
                window.showStatus('⚠️ Não conectado ao Supabase. Impossível carregar dados.', 'warning');
                return;
            }
            
            try {
                window.showStatus('📥 Carregando dados de jogadores...', 'loading');
                console.log("loadData: Iniciando carregamento de dados dos jogadores do Supabase...");

                const { data, error } = await supabase
                    .from('jogadores')
                    .select(`
                        id,
                        name,
                        active_for_draw,
                        posicao (
                            pontos,
                            vitorias,
                            derrotas,
                            empates
                        )
                    `);
                
                if (error) {
                    console.error("loadData: Erro ao buscar dados dos jogadores do Supabase:", error);
                    throw error;
                }
                
                console.log("loadData: Dados brutos recebidos do Supabase:", data); 

                players = data.map(jogador => ({
                    id: jogador.id,
                    name: jogador.name,
                    // Garante que 'posicao' é um array antes de tentar acessar [0]
                    points: jogador.posicao && jogador.posicao.length > 0 ? jogador.posicao[0].pontos : 0,
                    wins: jogador.posicao && jogador.posicao.length > 0 ? jogador.posicao[0].vitorias : 0,
                    draws: jogador.posicao && jogador.posicao.length > 0 ? jogador.posicao[0].empates : 0,
                    losses: jogador.posicao && jogador.posicao.length > 0 ? jogador.posicao[0].derrotas : 0,
                    activeForDraw: jogador.active_for_draw !== undefined ? jogador.active_for_draw : true
                }));
                
                console.log("loadData: Array 'players' após processamento:", players); 

                window.updatePlayersList();
                window.updateRanking();
                window.updateStats();
                window.checkDrawButtonState(); 
                
                window.showStatus('✅ Dados carregados com sucesso!', 'connected');
                
            } catch (error) {
                console.error('loadData: Erro geral na função loadData:', error);
                window.showStatus(`❌ Erro ao carregar dados: ${error.message}`, 'error');
            }
        };

        // Adiciona novo jogador
        window.addPlayer = async function() {
            if (!isConnected || !supabase) {
                alert('❌ Conecte-se ao Supabase primeiro!');
                console.warn("addPlayer: Não conectado ao Supabase.");
                return;
            }
            
            const name = document.getElementById('newPlayerName').value.trim();
            if (!name) {
                alert('❌ Digite o nome do jogador!');
                return;
            }
            
            try {
                window.showStatus('➕ Adicionando jogador...', 'loading');
                const { data: jogadorData, error: jogadorError } = await supabase
                    .from('jogadores')
                    .insert([{ 
                        name: name,
                        dtRegistro: new Date().toISOString(),
                        active_for_draw: true 
                    }])
                    .select();
                
                if (jogadorError) throw jogadorError;
                
                const jogadorId = jogadorData[0].id;
                
                const { error: posicaoError } = await supabase
                    .from('posicao')
                    .insert([{
                        idJogador: jogadorId,
                        pontos: 0,
                        vitorias: 0,
                        derrotas: 0,
                        empates: 0
                    }]);
                
                if (posicaoError) throw posicaoError;
                
                document.getElementById('newPlayerName').value = '';
                await window.loadData(); 
                alert('✅ Jogador adicionado com sucesso!');
                window.showStatus('✅ Jogador adicionado!', 'connected');
                
            } catch (error) {
                console.error('addPlayer: Erro ao adicionar jogador:', error);
                alert(`❌ Erro ao adicionar jogador: ${error.message}`);
                window.showStatus(`❌ Erro ao adicionar jogador: ${error.message}`, 'error');
            }
        };

        // Alterna o status de um jogador para o sorteio
        window.togglePlayerActiveStatus = async function(playerId) {
            if (!isConnected || !supabase) {
                alert('❌ Conecte-se ao Supabase primeiro!');
                return;
            }

            const playerIndex = players.findIndex(p => p.id === playerId);
            if (playerIndex === -1) {
                console.warn(`togglePlayerActiveStatus: Jogador com ID ${playerId} não encontrado.`);
                return;
            }

            const currentPlayer = players[playerIndex];
            const newStatus = !currentPlayer.activeForDraw; 

            try {
                window.showStatus('🔄 Atualizando status do jogador...', 'loading');
                const { error } = await supabase
                    .from('jogadores')
                    .update({ active_for_draw: newStatus }) 
                    .eq('id', playerId);

                if (error) throw error;

                players[playerIndex].activeForDraw = newStatus;
                
                window.updatePlayersList();
                window.checkDrawButtonState(); 
                alert(`✅ Aval da mulher para ${currentPlayer.name}, ${newStatus ? 'LIBERADO' : 'NÃO LIBERADO'}!.`);
                window.showStatus('✅ Status atualizado!', 'connected');

            } catch (error) {
                console.error('togglePlayerActiveStatus: Erro ao atualizar status do jogador:', error);
                alert(`❌ Erro ao atualizar status: ${error.message}`);
                window.showStatus(`❌ Erro ao atualizar status: ${error.message}`, 'error');
            }
        };

        // Atualiza lista de jogadores
        window.updatePlayersList = function() {
            const container = document.getElementById('playersList');
            if (players.length === 0) {
                console.log("updatePlayersList: Nenhum jogador no array 'players'. Exibindo mensagem padrão."); 
                container.innerHTML = '<p>Nenhum jogador cadastrado. Adicione jogadores para começar!</p>';
                return;
            }
            
            console.log("updatePlayersList: Atualizando lista de jogadores. Total de jogadores:", players.length); 

            const playerDivs = players.map(p => {
                const isFixedInA = fixedTeamA.some(fp => fp.id === p.id);
                const isFixedInB = fixedTeamB.some(fp => fp.id === p.id);
                const isDisabled = isFixedInA || isFixedInB; 

                return `
                    <div style="
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        gap: 8px;
                        background-color: ${p.activeForDraw ? '#e6ffe6' : '#ffe6e6'};
                        border: 1px solid ${p.activeForDraw ? '#4CAF50' : '#f44336'};
                        padding: 8px 12px;
                        border-radius: 5px;
                        margin-bottom: 5px;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
                        opacity: ${isDisabled ? '0.6' : '1'}; 
                        flex: 1 1 auto;
                        min-width: 250px;
                    ">
                        <div>
                            <span style="font-size: 1.2em;">${p.activeForDraw ? '👤' : '🚫'}</span> <span>${p.name}</span>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn ${p.activeForDraw ? 'btn-warning' : 'btn-secondary'}" 
                                    onclick="window.togglePlayerActiveStatus(${p.id})"
                                    style="padding: 5px 10px; font-size: 0.8em; border-radius: 15px; cursor: pointer;">
                                ${p.activeForDraw ? '👎':'👍'}
                            </button>
                            <button class="btn btn-primary" 
                                    onclick="window.addFixedPlayerToTeam('A', ${p.id})" 
                                    ${isDisabled || !p.activeForDraw ? 'disabled' : ''}
                                    style="padding: 5px 10px; font-size: 0.8em; border-radius: 15px; cursor: pointer;">
                                Fixar A
                            </button>
                            <button class="btn btn-danger" 
                                    onclick="window.addFixedPlayerToTeam('B', ${p.id})" 
                                    ${isDisabled || !p.activeForDraw ? 'disabled' : ''}
                                    style="padding: 5px 10px; font-size: 0.8em; border-radius: 15px; cursor: pointer;">
                                Fixar B
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `
                <div style="
                    background: white;
                    padding: 15px;
                    border-radius: 8px;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                ">
                    <strong>Jogadores:</strong>
                    <div style="
                        margin-top: 10px;
                        display: flex;
                        flex-wrap: wrap; 
                        gap: 10px;
                        justify-content: flex-start; 
                    ">
                        ${playerDivs}
                    </div>
                </div>
            `;

            window.updateFixedTeamsList(); 
        };

        // Adiciona jogador a um time fixo
        window.addFixedPlayerToTeam = function(team, playerId) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;

            const isAlreadyFixed = fixedTeamA.some(p => p.id === playerId) || fixedTeamB.some(p => p.id === playerId);
            if (isAlreadyFixed) {
                alert('Este jogador já está fixo em um time.');
                return;
            }

            if (!player.activeForDraw) {
                alert('Para fixar um jogador, ele precisa estar ativo para o sorteio (avaliado pela mulher)!');
                return;
            }

            if (team === 'A') {
                fixedTeamA.push(player);
            } else if (team === 'B') {
                fixedTeamB.push(player);
            }
            window.updatePlayersList(); 
            window.updateFixedTeamsList(); 
            window.checkDrawButtonState(); 
        };

        // Remove jogador de um time fixo
        window.removeFixedPlayer = function(team, playerId) {
            if (team === 'A') {
                fixedTeamA = fixedTeamA.filter(p => p.id !== playerId);
            } else if (team === 'B') {
                fixedTeamB = fixedTeamB.filter(p => p.id !== playerId);
            }
            window.updatePlayersList(); 
            window.updateFixedTeamsList(); 
            window.checkDrawButtonState(); 
        };

        // Atualiza a exibição dos jogadores fixos
        window.updateFixedTeamsList = function() {
            const fixedTeamAList = document.getElementById('fixedTeamA_list');
            const fixedTeamBList = document.getElementById('fixedTeamB_list');
            const fixedContainer = document.querySelector('.teams-fixed-container');

            fixedTeamAList.innerHTML = '';
            fixedTeamBList.innerHTML = '';

            fixedTeamA.forEach(player => {
                const li = document.createElement('li');
                li.innerHTML = `
                    ${player.name} 
                    <button class="btn btn-secondary" onclick="window.removeFixedPlayer('A', ${player.id})" style="padding: 3px 8px; font-size: 0.7em; border-radius: 10px; cursor: pointer;">
                        Remover
                    </button>
                `;
                fixedTeamAList.appendChild(li);
            });

            fixedTeamB.forEach(player => {
                const li = document.createElement('li');
                li.innerHTML = `
                    ${player.name} 
                    <button class="btn btn-secondary" onclick="window.removeFixedPlayer('B', ${player.id})" style="padding: 3px 8px; font-size: 0.7em; border-radius: 10px; cursor: pointer;">
                        Remover
                    </button>
                `;
                fixedTeamBList.appendChild(li);
            });

            if (fixedTeamA.length > 0 || fixedTeamB.length > 0) {
                fixedContainer.style.display = 'grid';
            } else {
                fixedContainer.style.display = 'none';
            }
        };

        // Corrige a lógica para ativar/desativar o botão de sorteio
        window.checkDrawButtonState = function() {
            const drawButton = document.getElementById('drawButton');
            const activePlayersCount = players.filter(p => p.activeForDraw).length;
            const minPlayersNeeded = 12; 
            
            const teamsAreCurrentlyDrawnAndPersisted = localStorage.getItem('hasDrawnTeams') === 'true';

            if (teamsAreCurrentlyDrawnAndPersisted) {
                drawButton.disabled = true;
                drawButton.innerHTML = '🎯 Times Sorteados';
            } else if (activePlayersCount < minPlayersNeeded) {
                drawButton.disabled = true;
                drawButton.innerHTML = `🚫 Adicione jogadores para sortear (${activePlayersCount}/${minPlayersNeeded})`;
            } else {
                drawButton.disabled = false;
                drawButton.innerHTML = '🎯 Sortear Times';
            }
            console.log(`checkDrawButtonState: Jogadores ativos: ${activePlayersCount}. Mínimo necessário: ${minPlayersNeeded}. Botão desabilitado: ${drawButton.disabled}`);
        };

        // Sorteia times
        window.drawTeams = function() {
            const allActivePlayers = players.filter(p => p.activeForDraw);

            const minPlayersNeeded = 12;
            if (allActivePlayers.length < minPlayersNeeded) {
                alert(`❌ É necessário ter pelo menos ${minPlayersNeeded} jogadores ativos para sortear os times!`);
                console.warn(`drawTeams: Tentativa de sorteio com menos de ${minPlayersNeeded} jogadores ativos.`);
                return;
            }

            let tempTeamA = [...fixedTeamA];
            let tempTeamB = [...fixedTeamB];

            const availableForRandomDraw = allActivePlayers.filter(p => 
                !fixedTeamA.some(fp => fp.id === p.id) && 
                !fixedTeamB.some(fp => fp.id === p.id)
            );

            const shuffledAvailable = [...availableForRandomDraw].sort(() => Math.random() - 0.5);

            let currentShuffledIndex = 0;

            while (currentShuffledIndex < shuffledAvailable.length) {
                if (tempTeamA.length <= tempTeamB.length) {
                    tempTeamA.push(shuffledAvailable[currentShuffledIndex]);
                } else {
                    tempTeamB.push(shuffledAvailable[currentShuffledIndex]);
                }
                currentShuffledIndex++;
            }
            
            currentTeamA = tempTeamA;
            currentTeamB = tempTeamB;

            const playersInGameIds = new Set([...currentTeamA.map(p => p.id), ...currentTeamB.map(p => p.id)]);
            const playersNotInGame = allActivePlayers.filter(p => !playersInGameIds.has(p.id));
            
            window.displayTeams(playersNotInGame);
            document.getElementById('resultSection').style.display = 'block';
            
            document.getElementById('drawButton').disabled = true;
            document.getElementById('drawButton').innerHTML = '🎯 Times Sorteados';

            localStorage.setItem('savedCurrentTeamA', JSON.stringify(currentTeamA));
            localStorage.setItem('savedCurrentTeamB', JSON.stringify(currentTeamB));
            localStorage.setItem('savedPlayersNotInGame', JSON.stringify(playersNotInGame));
            localStorage.setItem('hasDrawnTeams', 'true');
            console.log("drawTeams: Times sorteados e salvos no localStorage.");
        };

        // Exibe times sorteados e jogadores não selecionados
        window.displayTeams = function(playersNotInGame) {
            const teamAList = document.getElementById('teamA');
            const teamBList = document.getElementById('teamB');
            const teamsContainer = document.getElementById('teamsContainer');
            const reservesList = document.getElementById('reservesList');
            const reservesSection = document.getElementById('reservesSection');

            teamAList.innerHTML = '';
            teamBList.innerHTML = '';
            reservesList.innerHTML = '';

            currentTeamA.forEach(player => {
                const li = document.createElement('li');
                li.textContent = player.name;
                teamAList.appendChild(li);
            });
            
            currentTeamB.forEach(player => {
                const li = document.createElement('li');
                li.textContent = player.name;
                teamBList.appendChild(li);
            });
            
            if (playersNotInGame.length > 0) {
                playersNotInGame.forEach(player => {
                    const li = document.createElement('li');
                    li.textContent = player.name;
                    reservesList.appendChild(li);
                });
                reservesSection.style.display = 'block';
                console.log(`displayTeams: ${playersNotInGame.length} jogadores no banco.`);
            } else {
                reservesSection.style.display = 'none';
                console.log("displayTeams: Nenhum jogador no banco.");
            }

            teamsContainer.style.display = 'grid';
            console.log("displayTeams: Times exibidos.");
        };

        // Registra resultado do jogo
        window.registerResult = async function() {
            if (!isConnected || !supabase) {
                alert('❌ Conecte-se ao Supabase primeiro!');
                return;
            }
            
            const result = document.getElementById('gameResult').value;
            if (!result) {
                alert('❌ Por favor, selecione o resultado do jogo!');
                return;
            }
            
            if (currentTeamA.length === 0 || currentTeamB.length === 0) {
                alert('❌ É necessário sortear os times primeiro!');
                return;
            }
            
            try {
                window.showStatus('📈 Registrando resultado...', 'loading');
                const updates = [];
                
                if (result === 'teamA') {
                    currentTeamA.forEach(player => {
                        updates.push({
                            idJogador: player.id,
                            pontos: player.points + 3,
                            vitorias: player.wins + 1,
                            derrotas: player.losses,
                            empates: player.draws
                        });
                    });
                    currentTeamB.forEach(player => {
                        updates.push({
                            idJogador: player.id,
                            pontos: player.points + 1,
                            vitorias: player.wins,
                            derrotas: player.losses + 1,
                            empates: player.draws
                        });
                    });
                } else if (result === 'teamB') {
                    currentTeamB.forEach(player => {
                        updates.push({
                            idJogador: player.id,
                            pontos: player.points + 3,
                            vitorias: player.wins + 1,
                            derrotas: player.losses,
                            empates: player.draws
                        });
                    });
                    currentTeamA.forEach(player => {
                        updates.push({
                            idJogador: player.id,
                            pontos: player.points + 1,
                            vitorias: player.wins,
                            derrotas: player.losses + 1,
                            empates: player.draws
                        });
                    });
                } else if (result === 'draw') {
                    [...currentTeamA, ...currentTeamB].forEach(player => {
                        updates.push({
                            idJogador: player.id,
                            pontos: player.points + 2,
                            vitorias: player.wins,
                            derrotas: player.losses,
                            empates: player.draws + 1
                        });
                    });
                }
                
                for (const update of updates) {
                    const { error } = await supabase
                        .from('posicao')
                        .update({
                            pontos: update.pontos,
                            vitorias: update.vitorias,
                            derrotas: update.derrotas,
                            empates: update.empates
                        })
                        .eq('idJogador', update.idJogador);
                    
                    if (error) throw error;
                }
                
                await window.loadData(); 
                
                document.getElementById('gameResult').value = '';
                document.getElementById('resultSection').style.display = 'none';
                document.getElementById('teamsContainer').style.display = 'none';
                document.getElementById('reservesSection').style.display = 'none';
                currentTeamA = []; 
                currentTeamB = []; 
                fixedTeamA = []; 
                fixedTeamB = [];
                window.updateFixedTeamsList(); 
                window.updatePlayersList(); 

                alert('✅ Resultado registrado com sucesso!');
                
                document.getElementById('drawButton').disabled = false;
                document.getElementById('drawButton').innerHTML = '🎯 Sortear Times'; 

                localStorage.removeItem('savedCurrentTeamA');
                localStorage.removeItem('savedCurrentTeamB');
                localStorage.removeItem('savedPlayersNotInGame');
                localStorage.removeItem('hasDrawnTeams');
                console.log("registerResult: Resultado registrado e dados do sorteio limpos.");

            } catch (error) {
                console.error('registerResult: Erro ao registrar resultado:', error);
                alert(`❌ Erro ao registrar resultado: ${error.message}`);
                window.showStatus(`❌ Erro ao registrar resultado: ${error.message}`, 'error');
            }
        };

        // Atualiza ranking (Classificação Geral) - NOVO MODELO: Tabela Clean
        window.updateRanking = function() {
            const sortedPlayers = [...players].sort((a, b) => {
                if (b.points !== a.points) return b.points - a.points;
                if (b.wins !== a.wins) return b.wins - a.wins;
                return b.draws - a.draws;
            });
            
            const tbody = document.getElementById('rankingTableBody');
            tbody.innerHTML = '';

            if (sortedPlayers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #777;">Nenhum jogador no ranking.</td></tr>';
                return;
            }

            const medalEmojis = ['🥇', '🥈', '🥉'];

            sortedPlayers.forEach((player, index) => {
                const row = document.createElement('tr');
                let rankClass = 'pos-default';
                let positionContent = `<span class="pos-badge-minimal ${rankClass}">${index + 1}</span>`;

                if (index < 3) {
                    rankClass = `pos-${index + 1}`;
                    positionContent = `<span class="pos-badge-minimal ${rankClass}">${medalEmojis[index]}</span>`;
                    row.classList.add('top-rank-row', `pos-${index + 1}`);
                }
                
                row.innerHTML = `
                    <td>${positionContent}</td>
                    <td>${player.name}</td>
                    <td><strong>${player.points}</strong></td>
                    <td>${player.wins}</td>
                    <td>${player.draws}</td>
                    <td>${player.losses}</td>
                `;
                tbody.appendChild(row);
            });
            console.log("updateRanking: Ranking atualizado.");
        };

        // Atualiza estatísticas
        window.updateStats = function() {
            document.getElementById('totalPlayers').textContent = players.length;
            
            const maxPoints = players.length > 0 ? Math.max(...players.map(p => p.points)) : 0;
            document.getElementById('leaderPoints').textContent = maxPoints;
            console.log("updateStats: Estatísticas atualizadas.");
        };

        // Reseta todos os dados
        window.resetAllData = async function() {
            if (!confirm('Tem certeza que deseja resetar todos os dados? Esta ação é irreversível.')) {
                return;
            }
            if (!isConnected || !supabase) {
                alert('❌ Conecte-se ao Supabase primeiro!');
                return;
            }
            try {
                window.showStatus('🗑️ Resetando dados...', 'loading');
                // Apaga dados de posicao
                let { error: error1 } = await supabase.from('posicao').delete().neq('idJogador', 0);
                if (error1) throw error1;

                // Apaga dados de jogadores
                let { error: error2 } = await supabase.from('jogadores').delete().neq('id', 0);
                if (error2) throw error2;

                await window.loadData();
                alert('✅ Dados resetados com sucesso!');

                localStorage.removeItem('savedCurrentTeamA');
                localStorage.removeItem('savedCurrentTeamB');
                localStorage.removeItem('savedPlayersNotInGame');
                localStorage.removeItem('hasDrawnTeams');
                console.log("resetAllData: Todos os dados resetados e localStorage limpo.");
                window.showStatus('✅ Todos os dados resetados!', 'connected');
                
            } catch (error) {
                console.error('resetAllData: Erro ao resetar:', error);
                alert(`❌ Erro ao resetar: ${error.message}`);
                window.showStatus(`❌ Erro ao resetar: ${error.message}`, 'error');
            }
        };
    </script>
</body>
</html>
