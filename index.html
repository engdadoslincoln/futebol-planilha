<script>
    // ================================
    // CONFIGURAÃ‡ÃƒO SUPABASE (FRONTEND)
    // ================================
    const SUPABASE_URL = 'https://ofdaxmhklseogkfsvmdx.supabase.co';
    const SUPABASE_PUBLISHABLE_KEY = 'sb_publishable_CuTQDFD26fEkDJqzXrLL7g_aIBBbnvD';

    let supabase = null;
    let players = [];
    let currentTeamA = [];
    let currentTeamB = [];
    let fixedTeamA = [];
    let fixedTeamB = [];
    let isConnected = false;

    // ================================
    // INICIALIZAÃ‡ÃƒO
    // ================================
    document.addEventListener('DOMContentLoaded', async function () {
        console.log("PÃ¡gina carregada. Iniciando conexÃ£o segura...");
        await connectSupabase();

        restoreDrawFromLocalStorage();
    });

    // ================================
    // CONEXÃƒO SUPABASE (APENAS PUBLISHABLE)
    // ================================
    async function connectSupabase() {
        try {
            if (!window.supabase) {
                throw new Error("SDK Supabase nÃ£o carregado.");
            }

            supabase = window.supabase.createClient(
                SUPABASE_URL,
                SUPABASE_PUBLISHABLE_KEY,
                {
                    auth: {
                        persistSession: false
                    }
                }
            );

            // Teste simples
            const { error } = await supabase
                .from('jogadores')
                .select('id')
                .limit(1);

            if (error) throw error;

            isConnected = true;
            showStatus('âœ… Conectado ao Supabase com Publishable Key!', 'connected');

            await loadData();

        } catch (error) {
            console.error("Erro na conexÃ£o:", error);
            showStatus(`âŒ Erro ao conectar: ${error.message}`, 'error');
            isConnected = false;
        }
    }

    // ================================
    // STATUS
    // ================================
    function showStatus(message, type) {
        const statusDiv = document.getElementById('connectionStatus');
        statusDiv.textContent = message;
        statusDiv.className = `connection-status status-${type}`;
    }

    // ================================
    // RESTAURAR TIMES DO LOCALSTORAGE
    // ================================
    function restoreDrawFromLocalStorage() {
        const savedTeamA = localStorage.getItem('savedCurrentTeamA');
        const savedTeamB = localStorage.getItem('savedCurrentTeamB');
        const savedReserves = localStorage.getItem('savedPlayersNotInGame');
        const hasDrawn = localStorage.getItem('hasDrawnTeams');

        if (savedTeamA && savedTeamB && hasDrawn === 'true') {
            currentTeamA = JSON.parse(savedTeamA);
            currentTeamB = JSON.parse(savedTeamB);
            const playersNotInGame = savedReserves ? JSON.parse(savedReserves) : [];

            displayTeams(playersNotInGame);
            document.getElementById('resultSection').style.display = 'block';
            document.getElementById('drawButton').disabled = true;
            document.getElementById('drawButton').innerHTML = 'ðŸŽ¯ Times Sorteados';
        }
    }

    // ================================
    // CARREGAR DADOS
    // ================================
    async function loadData() {
        if (!isConnected) return;

        try {
            showStatus('ðŸ“¥ Carregando jogadores...', 'loading');

            const { data, error } = await supabase
                .from('jogadores')
                .select(`
                    id,
                    name,
                    active_for_draw,
                    posicao (
                        pontos,
                        vitorias,
                        derrotas,
                        empates
                    )
                `);

            if (error) throw error;

            players = data.map(j => ({
                id: j.id,
                name: j.name,
                points: j.posicao?.[0]?.pontos ?? 0,
                wins: j.posicao?.[0]?.vitorias ?? 0,
                draws: j.posicao?.[0]?.empates ?? 0,
                losses: j.posicao?.[0]?.derrotas ?? 0,
                activeForDraw: j.active_for_draw ?? true
            }));

            updateRanking();
            updateStats();
            updatePlayersList();
            checkDrawButtonState();

            showStatus('âœ… Dados carregados!', 'connected');

        } catch (error) {
            showStatus(`âŒ Erro ao carregar: ${error.message}`, 'error');
        }
    }

    // ================================
    // ADICIONAR JOGADOR
    // ================================
    async function addPlayer() {
        if (!isConnected) return alert("NÃ£o conectado.");

        const name = document.getElementById('newPlayerName').value.trim();
        if (!name) return alert("Digite o nome.");

        try {
            const { data, error } = await supabase
                .from('jogadores')
                .insert([{
                    name,
                    dtRegistro: new Date().toISOString(),
                    active_for_draw: true
                }])
                .select();

            if (error) throw error;

            const jogadorId = data[0].id;

            await supabase.from('posicao').insert([{
                idJogador: jogadorId,
                pontos: 0,
                vitorias: 0,
                derrotas: 0,
                empates: 0
            }]);

            document.getElementById('newPlayerName').value = '';
            await loadData();
            alert("Jogador adicionado!");

        } catch (error) {
            alert(error.message);
        }
    }

    // ================================
    // ATUALIZAR RANKING
    // ================================
    function updateRanking() {
        const sorted = [...players]
            .filter(p => !p.name.toLowerCase().includes('avulso'))
            .sort((a, b) =>
                b.points - a.points ||
                b.wins - a.wins ||
                b.draws - a.draws
            );

        const tbody = document.getElementById('rankingTableBody');
        tbody.innerHTML = '';

        sorted.forEach((p, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${p.name}</td>
                <td><strong>${p.points}</strong></td>
                <td>${p.wins}</td>
                <td>${p.draws}</td>
                <td>${p.losses}</td>
            `;
            tbody.appendChild(row);
        });
    }

    // ================================
    // ESTATÃSTICAS
    // ================================
    function updateStats() {
        document.getElementById('totalPlayers').textContent = players.length;
        const maxPoints = players.length > 0 ? Math.max(...players.map(p => p.points)) : 0;
        document.getElementById('leaderPoints').textContent = maxPoints;
    }

    // ================================
    // EXPOR FUNÃ‡Ã•ES PARA HTML
    // ================================
    window.addPlayer = addPlayer;
</script>
